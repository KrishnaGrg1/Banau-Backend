// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN // Platform owner (you)
  TENANT_OWNER // Store owner (client)
  TENANT_STAFF // Store employee
  CUSTOMER // End customer
}

enum TenantStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum Plan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum TokenType {
  REFRESH
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum AssetType {
  LOGO
  FAVICON
  PRODUCT_IMAGE
  BANNER
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELLED
  REFUNDED
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(CUSTOMER)

  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  isActive   Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // ✅ ONE user → ONE owned tenant
  ownedTenant Tenant?

  staffTenants    TenantStaff[]
  tokens          Token[]
  customerProfile Customer?

  @@index([email])
  @@index([role])
  @@map("users")
}

model Token {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      TokenType @default(REFRESH)
  expiresAt DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("tokens")
}

// ============================================
// TENANT (STORE)
// ============================================

model Tenant {
  id        String @id @default(uuid())
  subdomain String @unique
  name      String
  email     String

  status TenantStatus @default(TRIAL)
  plan   Plan         @default(FREE)

  published   Boolean   @default(false)
  publishedAt DateTime?

  // ✅ Enforced one-to-one
  ownerId String @unique
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  settings  Setting?
  staff     TenantStaff[]
  products  Product[]
  customers Customer[]
  assets    Asset[]
  orders    Order[]

  @@index([subdomain])
  @@index([status])
  @@map("tenants")
}

// ============================================
// TENANT STAFF
// ============================================

model TenantStaff {
  id       String @id @default(uuid())
  tenantId String
  userId   String

  // Permissions
  canManageProducts  Boolean @default(true)
  canManageOrders    Boolean @default(true)
  canManageCustomers Boolean @default(false)
  canViewAnalytics   Boolean @default(false)
  canManageStaff     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_staff")
}

// ============================================
// SETTINGS
// ============================================

model Setting {
  id String @id @default(uuid())

  // Colors
  primaryColorCode        String @default("#4F46E5")
  secondaryColorCode      String @default("#EC4899")
  primaryTextColorCode    String @default("#1F2937")
  secondaryTextColorCode  String @default("#6B7280")
  backgroundColorCode     String @default("#FFFFFF")
  backgroundTextColorCode String @default("#000000")

  // Landing page
  landingPageTitle       String @default("Welcome to our store")
  landingPageDescription String @default("Discover amazing products")

  // Asset references (optional)
  logoId    String?
  faviconId String?

  // Relations
  logo    Asset? @relation("LogoAsset", fields: [logoId], references: [id])
  favicon Asset? @relation("FaviconAsset", fields: [faviconId], references: [id])

  // One-to-one with Tenant
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("settings")
}

// ============================================
// ASSETS
// ============================================

model Asset {
  id String @id @default(uuid())

  // File info
  fileName String
  url      String
  fileSize Int // Size in bytes
  mimeType String? // e.g., "image/png"
  type     AssetType

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Reverse relations for settings
  logoSettings    Setting[] @relation("LogoAsset")
  faviconSettings Setting[] @relation("FaviconAsset")

  // For product images
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@map("assets")
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id       String @id @default(uuid())
  tenantId String

  name        String
  description String? @db.Text
  slug        String

  // Pricing
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)

  // Inventory
  quantity       Int     @default(0)
  trackInventory Boolean @default(true)

  // Featured image
  featuredImageId String?
  featuredImage   Asset?  @relation(fields: [featuredImageId], references: [id])

  // Status
  status   ProductStatus @default(DRAFT)
  featured Boolean       @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@unique([tenantId, slug])
  @@index([tenantId, status])
  @@map("products")
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// ============================================
// CUSTOMERS
// ============================================

model Customer {
  id       String  @id @default(uuid())
  tenantId String
  userId   String? @unique

  email     String
  firstName String
  lastName  String
  phone     String?

  // Stats
  totalSpent  Decimal @default(0) @db.Decimal(10, 2)
  ordersCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id])
  orders Order[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("customers")
}

model Order {
  id         String      @id @default(uuid())
  tenantId   String
  customerId String
  status     OrderStatus @default(PENDING) // enum for status
  total      Decimal     @db.Decimal(10, 2)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items    OrderItem[]

  @@index([tenantId])
  @@index([customerId])
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}
