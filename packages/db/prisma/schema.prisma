// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN // Platform owner (you)
  TENANT_OWNER // Store owner (client)
  TENANT_STAFF // Store employee
  CUSTOMER // End customer
}

enum TenantStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum Plan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum TokenType {
  REFRESH
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum AssetType {
  LOGO
  FAVICON
  PRODUCT_IMAGE
  BANNER
}

enum OrderStatus {
  PENDING // Payment pending / Draft
  PAID // Payment successful
  PROCESSING // Being prepared
  SHIPPED // On the way
  DELIVERED // Completed
  CANCELLED // Cancelled
  REFUNDED // Money returned
  FAILED // Payment failed
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(TENANT_OWNER)

  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  isActive   Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // ✅ ONE user → ONE owned tenant
  ownedTenant Tenant?

  staffTenants    TenantStaff[]
  tokens          Token[]
  customerProfile Customer?

  @@index([email])
  @@index([role])
  @@map("users")
}

model Token {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      TokenType @default(REFRESH)
  expiresAt DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("tokens")
}

// ============================================
// TENANT (STORE)
// ============================================

model Tenant {
  id        String @id @default(uuid())
  subdomain String @unique
  name      String
  email     String

  status TenantStatus @default(TRIAL)
  plan   Plan         @default(FREE)

  published   Boolean   @default(false)
  publishedAt DateTime?

  // ✅ Enforced one-to-one
  ownerId String @unique
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  settings  Setting?
  staff     TenantStaff[]
  products  Product[]
  customers Customer[]
  assets    Asset[]
  orders    Order[]

  @@index([subdomain])
  @@index([status])
  @@map("tenants")
}

// ============================================
// TENANT STAFF
// ============================================

model TenantStaff {
  id       String @id @default(uuid())
  tenantId String
  userId   String

  // Permissions
  canManageProducts  Boolean @default(true)
  canManageOrders    Boolean @default(true)
  canManageCustomers Boolean @default(false)
  canViewAnalytics   Boolean @default(false)
  canManageStaff     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_staff")
}

// ============================================
// SETTINGS
// ============================================

model Setting {
  id String @id @default(uuid())

  // Colors
  primaryColorCode        String @default("#4F46E5")
  secondaryColorCode      String @default("#EC4899")
  primaryTextColorCode    String @default("#1F2937")
  secondaryTextColorCode  String @default("#6B7280")
  backgroundColorCode     String @default("#FFFFFF")
  backgroundTextColorCode String @default("#000000")

  // Landing page
  landingPageTitle       String @default("Welcome to our store")
  landingPageDescription String @default("Discover amazing products")

  // Asset references (optional)
  logoId    String?
  faviconId String?

  // Relations
  logo    Asset? @relation("LogoAsset", fields: [logoId], references: [id])
  favicon Asset? @relation("FaviconAsset", fields: [faviconId], references: [id])

  // One-to-one with Tenant
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("settings")
}

// ============================================
// ASSETS
// ============================================

model Asset {
  id String @id @default(uuid())

  // File info
  fileName String
  url      String
  fileSize Int // Size in bytes
  mimeType String? // e.g., "image/png"
  type     AssetType

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Reverse relations for settings
  logoSettings    Setting[] @relation("LogoAsset")
  faviconSettings Setting[] @relation("FaviconAsset")

  // For product images
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@map("assets")
}

// ============================================
// CUSTOMERS
// ============================================

model Customer {
  id       String  @id @default(uuid())
  tenantId String
  userId   String? @unique

  email     String
  firstName String
  lastName  String
  phone     String?

  // Stats
  totalSpent  Decimal @default(0) @db.Decimal(10, 2)
  ordersCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id])
  orders Order[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("customers")
}

model Order {
  id         String      @id @default(uuid())
  tenantId   String
  customerId String
  status     OrderStatus @default(PENDING) // enum for status

  subtotal Decimal  @db.Decimal(10, 2) // Items total
  tax      Decimal? @db.Decimal(10, 2) // Tax amount
  shipping Decimal? @db.Decimal(10, 2) // Shipping cost
  discount Decimal? @db.Decimal(10, 2) // Discount amount
  total    Decimal  @db.Decimal(10, 2) // Final total

  // Payment info
  paymentIntentId String? // Stripe payment intent ID
  paymentMethod   String? // "card", "cash", etc.

  //shipping info
  ShippingfirstName     String?
  ShippinglastName      String?
  ShippingEmail         String?
  ShippingContactNumber String?
  ShippingCountry       String?
  ShippingState         String?
  ShippingDistrict      String?
  ShippingCity          String?
  ShippingAddress       String?

  //order tracking info
  trackingNumber  String?
  trackingCarrier String? // "UPS", "FedEx", etc.
  trackingUrl     String?

  //notes
  notes         String? // Internal notes (staff only)
  customerNotes String? // Notes from customer

  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items    OrderItem[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  paidAt      DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?

  @@index([tenantId])
  @@index([customerId])
}

// ============================================
// PRODUCTS (Updated)
// ============================================

model Product {
  id       String @id @default(uuid())
  tenantId String

  name        String
  description String? @db.Text
  slug        String

  // Base pricing (can be overridden by variants)
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)

  // Base inventory (used if no variants)
  quantity       Int     @default(0)
  trackInventory Boolean @default(true)

  // SKU & Barcode (base level)
  sku     String?
  barcode String?

  // Featured image
  featuredImageId String?
  featuredImage   Asset?  @relation(fields: [featuredImageId], references: [id])

  // Status
  status   ProductStatus @default(DRAFT)
  featured Boolean       @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Shipping
  weight     Decimal? @db.Decimal(10, 2)
  weightUnit String?  @default("kg") // kg, lb, oz, g

  // Tax
  taxable Boolean @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  tenant     Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  variants   ProductVariant[]
  orderItems OrderItem[]

  @@unique([tenantId, slug])
  @@index([tenantId, status])
  @@index([slug])
  @@map("products")
}

// ============================================
// PRODUCT VARIANTS (NEW!)
// ============================================

model ProductVariant {
  id        String @id @default(uuid())
  productId String

  // Variant display name (e.g., "Small / Red")
  name String

  // SKU & Barcode (variant-specific)
  sku     String?
  barcode String?

  // Pricing (overrides product price if set)
  price          Decimal? @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)

  // Inventory (variant-specific)
  quantity Int @default(0)

  // Variant options (up to 3 levels)
  option1Name  String? // e.g., "Size"
  option1Value String? // e.g., "Small"
  option2Name  String? // e.g., "Color"
  option2Value String? // e.g., "Red"
  option3Name  String? // e.g., "Material"
  option3Value String? // e.g., "Cotton"

  // Image (variant-specific, optional)
  imageUrl String?

  // Position/order
  position Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@unique([productId, sku])
  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// ============================================
// ORDER ITEMS (Updated to support variants)
// ============================================

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String

  // ✅ NEW: Optional variant
  variantId String?

  quantity Int
  price    Decimal @db.Decimal(10, 2)

  // Store snapshot of product/variant name at time of purchase
  productName String
  variantName String?

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}
